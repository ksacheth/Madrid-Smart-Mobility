<!--
Madrid Smart Mobility — Interactive map extension
Adds a Leaflet map with:
- heatmap toggle (trips vs collisions)
- route example: Puerta del Sol → Plaza Mayor (polyline + summary)
- safety scoring per station and safe-spot highlighting

Open this file locally or deploy via GitHub Pages / Vercel. The map uses OpenStreetMap tiles and leaflet-heat plugin.
-->

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Madrid Smart Mobility — Map & Heat</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="" crossorigin="" />
  <style>
    :root{--bg:#f4f7fb;--muted:#6c7a89;--accent:#0b84ff}
    body{font-family:Inter,system-ui,Arial;margin:0;background:var(--bg);color:#0b1220}
    .wrap{max-width:1200px;margin:18px auto;padding:18px}
    header{display:flex;gap:12px;align-items:center}
    h1{margin:0;font-size:22px}
    .sub{color:var(--muted);font-size:13px}
    .layout{display:grid;grid-template-columns:1fr 360px;gap:18px;margin-top:14px}
    .card{background:white;border-radius:10px;padding:14px;box-shadow:0 8px 24px rgba(20,30,50,0.06)}
    #map{height:560px;border-radius:8px}
    .controls{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
    .btn{background:var(--accent);color:white;border:none;padding:8px 10px;border-radius:8px;cursor:pointer}
    .btn.secondary{background:#f3f7fb;color:#0b1220;border:1px solid #e6f0fb}
    .legend{margin-top:12px;font-size:13px;color:var(--muted)}
    .station-list{max-height:240px;overflow:auto;margin-top:10px}
    .station-item{padding:8px;border-radius:8px;border:1px solid #eef5fb;margin-bottom:8px}
    @media (max-width:980px){.layout{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/7/7a/Madrid_municipal_logo.svg/600px-Madrid_municipal_logo.svg.png" width="56" style="border-radius:8px" alt="Madrid">
      <div>
        <h1>Madrid Smart Mobility</h1>
        <div class="sub">Interactive map: heat filters, example route, and safe-spot identification</div>
      </div>
    </header>

    <div class="layout">
      <div class="card">
        <h2 style="margin-top:0">Map & Heat Controls</h2>
        <div id="map"></div>

        <div class="controls">
          <button class="btn" id="heatTripsBtn">Show heat: trip density</button>
          <button class="btn secondary" id="heatCollBtn">Show heat: collisions</button>
          <button class="btn secondary" id="clearHeatBtn">Clear heat</button>
          <button class="btn" id="routeBtn">Show example route: Sol → Plaza Mayor</button>
          <button class="btn secondary" id="safeSpotsBtn">Highlight safe spots</button>
        </div>

        <div class="legend" id="legend">Tip: toggle heatmap to inspect hotspots. Click station markers for details.</div>
      </div>

      <aside class="card">
        <h3 style="margin-top:0">Stations & Safety</h3>
        <div class="station-list" id="stationList"></div>
        <div style="margin-top:10px" class="sub">Safety metric: lower collisions and higher availability = safer.</div>
      </aside>
    </div>
  </div>

  <!-- Leaflet + heat plugin -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <script>
    // Mock dataset: stations with coordinates, availability, trip_count, collision_count
    const stations = [
      {id: '1001', name: 'Puerta del Sol', lat: 40.416775, lon: -3.703790, bikes: 8, cap: 20, trips: 120, collisions: 1},
      {id: '1012', name: 'Plaza Mayor', lat: 40.415524, lon: -3.707412, bikes: 5, cap: 15, trips: 90, collisions: 0},
      {id: '2030', name: 'Atocha', lat: 40.406876, lon: -3.690486, bikes: 12, cap: 20, trips: 200, collisions: 2},
      {id: '3120', name: 'Argüelles', lat: 40.432167, lon: -3.717857, bikes: 3, cap: 18, trips: 45, collisions: 0},
      {id: '4120', name: 'Chamartín', lat: 40.4720, lon: -3.6844, bikes: 10, cap: 20, trips: 60, collisions: 1},
      {id: '5201', name: 'Malasaña', lat: 40.4259, lon: -3.7080, bikes: 6, cap: 15, trips: 80, collisions: 1}
    ];

    // Prepare map
    const map = L.map('map').setView([40.4168, -3.7038], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Marker layers and heat layers
    const stationLayer = L.layerGroup().addTo(map);
    let heatLayer = null;
    let routeLayer = L.layerGroup().addTo(map);

    // Utility: color by safety score
    function safetyScore(s){
      // score: higher = safer
      // heuristic: available ratio minus normalized collisions
      const avail = (s.bikes || 0) / (s.cap || 1); // 0..1
      const collFactor = Math.min(s.collisions || 0, 5)/5; // 0..1
      return avail - collFactor*0.6; // range approx [-0.6..1]
    }

    function safetyColor(score){
      if(score > 0.5) return '#1a9850'; // green
      if(score > 0.1) return '#ffd92f'; // yellow
      return '#ef4444'; // red
    }

    // Add station markers
    stations.forEach(s => {
      const score = safetyScore(s);
      const marker = L.circleMarker([s.lat, s.lon], {
        radius: 8, fillOpacity: 0.9, color: '#fff', weight:1, fillColor: safetyColor(score)
      }).addTo(stationLayer);
      marker.bindPopup(`<strong>${s.name} (${s.id})</strong><br/>Bikes: ${s.bikes}/${s.cap}<br/>Trips: ${s.trips}<br/>Collisions: ${s.collisions}<br/>Safety: ${ (score).toFixed(2) }`);
      marker.on('click', ()=>{
        marker.openPopup();
      });
    });

    // Populate station list in sidebar
    const list = document.getElementById('stationList');
    stations.forEach(s => {
      const el = document.createElement('div'); el.className='station-item';
      const score = safetyScore(s);
      el.innerHTML = `<strong>${s.id} — ${s.name}</strong><div style="margin-top:6px;color:var(--muted)">Bikes: ${s.bikes}/${s.cap} &nbsp;·&nbsp; Trips: ${s.trips} &nbsp;·&nbsp; Collisions: ${s.collisions}</div><div style="margin-top:8px;color:${safetyColor(score)}">Safety score: ${score.toFixed(2)}</div>`;
      el.addEventListener('click', ()=>{ map.flyTo([s.lat,s.lon],15); });
      list.appendChild(el);
    });

    // Build heat arrays
    const tripHeatPoints = stations.map(s => [s.lat, s.lon, Math.max(0.5, s.trips/50)]); // intensity scaled
    const collHeatPoints = stations.map(s => [s.lat, s.lon, Math.max(0.5, s.collisions)]);

    // Heat buttons
    document.getElementById('heatTripsBtn').addEventListener('click', ()=>{
      if(heatLayer) map.removeLayer(heatLayer);
      heatLayer = L.heatLayer(tripHeatPoints, {radius: 40, blur:25, maxZoom: 17}).addTo(map);
      document.getElementById('legend').textContent = 'Heat: trip density (darker = more trips)';
    });
    document.getElementById('heatCollBtn').addEventListener('click', ()=>{
      if(heatLayer) map.removeLayer(heatLayer);
      heatLayer = L.heatLayer(collHeatPoints, {radius: 50, blur:30, maxZoom: 17}).addTo(map);
      document.getElementById('legend').textContent = 'Heat: collisions (darker = more collisions)';
    });
    document.getElementById('clearHeatBtn').addEventListener('click', ()=>{ if(heatLayer) map.removeLayer(heatLayer); heatLayer=null; document.getElementById('legend').textContent='Tip: toggle heatmap to inspect hotspots. Click station markers for details.'});

    // Example route: Puerta del Sol -> Plaza Mayor
    const sol = stations.find(s=>s.id==='1001');
    const plaza = stations.find(s=>s.id==='1012');
    function showRoute(){
      routeLayer.clearLayers();
      if(!sol || !plaza) return alert('Example stations not found');
      // Simple straight polyline; for production use a routing API if available
      const poly = L.polyline([[sol.lat,sol.lon],[plaza.lat,plaza.lon]],{color:'#0b84ff',weight:4,opacity:0.9}).addTo(routeLayer);
      // markers with popups
      L.marker([sol.lat,sol.lon]).addTo(routeLayer).bindPopup(`<strong>${sol.name}</strong>`).openPopup();
      L.marker([plaza.lat,plaza.lon]).addTo(routeLayer).bindPopup(`<strong>${plaza.name}</strong>`);
      map.fitBounds(poly.getBounds().pad(0.4));
      // compute simple distance/time
      const d = haversine(sol.lat,sol.lon,plaza.lat,plaza.lon); // km
      const avgSpeedKmh = 12; // typical bike speed
      const mins = Math.round((d/avgSpeedKmh)*60);
      document.getElementById('legend').textContent = `Route: ${sol.name} → ${plaza.name} — approx ${d.toFixed(2)} km, ~${mins} min by bike (straight-line example)`;
    }
    document.getElementById('routeBtn').addEventListener('click', showRoute);

    // Safe spot highlighting: markers with high safety score
    function highlightSafeSpots(){
      // find top 3 by safety score
      const ranked = stations.map(s=>({s,score:safetyScore(s)})).sort((a,b)=>b.score-a.score);
      const top = ranked.slice(0,3).map(r=>r.s);
      // animate / open popups
      top.forEach(t=>{
        const m = L.circleMarker([t.lat,t.lon],{radius:14,fillColor:'#1a9850',color:'#fff',weight:2,fillOpacity:0.9}).addTo(routeLayer);
        setTimeout(()=>{ m.bindPopup(`<strong>Safe spot: ${t.name}</strong><br/>Safety ${(safetyScore(t)).toFixed(2)}`).openPopup(); }, 200);
        setTimeout(()=>{ map.flyTo([t.lat,t.lon],14); }, 600);
      });
      document.getElementById('legend').textContent = `Highlighted top ${top.length} safe spots (based on mock data)`;
    }
    document.getElementById('safeSpotsBtn').addEventListener('click', highlightSafeSpots);

    // utility: haversine distance (km)
    function haversine(lat1,lon1,lat2,lon2){
      function toRad(v){return v*Math.PI/180}
      const R=6371; const dLat=toRad(lat2-lat1); const dLon=toRad(lon2-lon1);
      const a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2);
      const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)); return R*c;
    }

    // Helpful: center map on Sol by default
    map.setView([sol.lat,sol.lon],14);

  </script>
</body>
</html>
