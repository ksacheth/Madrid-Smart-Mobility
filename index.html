<!--
Madrid Smart Mobility ‚Äî Interactive map extension
Adds a Leaflet map with:
- heatmap toggle (trips vs collisions)
- multiple example routes:
  - Puerta del Sol ‚Üí Plaza Mayor (direct)
  - Puerta del Sol ‚Üí Plaza Mayor (via Malasa√±a)
  - Puerta del Sol ‚Üí Atocha (direct)
- safety scoring per station and safe-spot highlighting

Open this file locally or deploy via GitHub Pages / Vercel. The map uses OpenStreetMap tiles and leaflet-heat plugin.
-->

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Madrid Smart Mobility ‚Äî Map & Heat</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="" crossorigin="" />
  <style>
    :root{
      --bg:#f4f7fb;
      --bg-elevated:#ffffff;
      --text:#0b1220;
      --muted:#6c7a89;
      --accent:#0b84ff;
      --nav-bg:#ffffff;
      --border:#eef5fb;
    }

    body.dark{
      --bg:#020617;
      --bg-elevated:#020617;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --accent:#38bdf8;
      --nav-bg:#020617;
      --border:#1f2937;
    }

    html{
      scroll-behavior:smooth;
    }

    body{
      font-family:Inter,system-ui,Arial;
      margin:0;
      background:var(--bg);
      color:var(--text);
      padding-top:64px; /* space for fixed navbar */
    }

    /* NAVBAR */
    nav{
      position:fixed;
      top:0;
      left:0;
      right:0;
      z-index:1000;
      background:var(--nav-bg);
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 24px;
    }

    .nav-left{
      display:flex;
      align-items:center;
      gap:18px;
      font-size:14px;
    }

    .brand{
      font-weight:600;
      font-size:15px;
      white-space:nowrap;
    }

    .nav-links{
      display:flex;
      gap:14px;
      flex-wrap:wrap;
    }

    .nav-links a{
      text-decoration:none;
      color:var(--text);
      font-weight:500;
      font-size:13px;
      opacity:0.8;
    }

    .nav-links a:hover{
      opacity:1;
    }

    #themeToggle{
      border:none;
      border-radius:999px;
      padding:6px 14px;
      font-size:13px;
      cursor:pointer;
      background:var(--accent);
      color:#ffffff;
    }

    .wrap{
      max-width:1200px;
      margin:18px auto;
      padding:18px;
    }

    header{
      display:flex;
      gap:12px;
      align-items:center;
    }

    h1{
      margin:0;
      font-size:22px;
    }

    .sub{
      color:var(--muted);
      font-size:13px;
    }

    .layout{
      display:grid;
      grid-template-columns:1fr 360px;
      gap:18px;
      margin-top:14px;
    }

    .card{
      background:var(--bg-elevated);
      border-radius:10px;
      padding:14px;
      box-shadow:0 8px 24px rgba(20,30,50,0.06);
      border:1px solid var(--border);
    }

    #map{
      height:560px;
      border-radius:8px;
    }

    .controls{
      display:flex;
      gap:8px;
      margin-top:10px;
      flex-wrap:wrap;
    }

    .btn{
      background:var(--accent);
      color:white;
      border:none;
      padding:8px 10px;
      border-radius:8px;
      cursor:pointer;
      font-size:13px;
    }

    .btn.secondary{
      background:var(--bg-elevated);
      color:var(--text);
      border:1px solid var(--border);
    }

    .legend{
      margin-top:12px;
      font-size:13px;
      color:var(--muted);
    }

    .station-list{
      max-height:240px;
      overflow:auto;
      margin-top:10px;
    }

    .station-item{
      padding:8px;
      border-radius:8px;
      border:1px solid var(--border);
      margin-bottom:8px;
    }

    @media (max-width:980px){
      .layout{
        grid-template-columns:1fr;
      }
    }
  </style>
</head>
<body>
  <!-- NAVBAR -->
  <nav>
    <div class="nav-left">
      <span class="brand">Madrid Smart Mobility</span>
      <div class="nav-links">
        <a href="#home">Overview</a>
        <a href="#map-section">Map</a>
        <a href="#stations-section">Stations</a>
      </div>
    </div>
    <button id="themeToggle">üåô Dark</button>
  </nav>

  <div class="wrap">
    <section id="home">
      <header>
        <img src="./WhatsApp Image 2025-11-16 at 21.48.28.jpeg" width="56" style="border-radius:8px" alt="Madrid">
        <div>
          <h1>Madrid Smart Mobility</h1>
          <div class="sub">Interactive map: heat filters, example routes, and safe-spot identification</div>
        </div>
      </header>
    </section>

    <section id="map-section">
      <div class="layout">
        <div class="card">
          <h2 style="margin-top:0">Map & Heat Controls</h2>
          <div id="map"></div>

          <div class="controls">
            <button class="btn" id="heatTripsBtn">Show heat: trip density</button>
            <button class="btn secondary" id="heatCollBtn">Show heat: collisions</button>
            <button class="btn secondary" id="clearHeatBtn">Clear heat</button>

            <!-- New multiple route buttons -->
            <button class="btn" id="routeSolPlazaDirectBtn">Route: Sol ‚Üí Plaza Mayor (direct)</button>
            <button class="btn secondary" id="routeSolPlazaScenicBtn">Route: Sol ‚Üí Plaza Mayor (via Malasa√±a)</button>
            <button class="btn secondary" id="routeSolAtochaBtn">Route: Sol ‚Üí Atocha (direct)</button>

            <button class="btn secondary" id="safeSpotsBtn">Highlight safe spots</button>
          </div>

          <div class="legend" id="legend">Tip: toggle heatmap to inspect hotspots. Click station markers for details.</div>
        </div>

        <aside class="card" id="stations-section">
          <h3 style="margin-top:0">Stations & Safety</h3>
          <div class="station-list" id="stationList"></div>
          <div style="margin-top:10px" class="sub">Safety metric: lower collisions and higher availability = safer.</div>
        </aside>
      </div>
    </section>
  </div>

  <!-- Leaflet + heat plugin -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <script>
    // Mock dataset: stations with coordinates, availability, trip_count, collision_count
    const stations = [
      {id: '1001', name: 'Puerta del Sol', lat: 40.416775, lon: -3.703790, bikes: 8, cap: 20, trips: 120, collisions: 1},
      {id: '1012', name: 'Plaza Mayor', lat: 40.415524, lon: -3.707412, bikes: 5, cap: 15, trips: 90, collisions: 0},
      {id: '2030', name: 'Atocha', lat: 40.406876, lon: -3.690486, bikes: 12, cap: 20, trips: 200, collisions: 2},
      {id: '3120', name: 'Arg√ºelles', lat: 40.432167, lon: -3.717857, bikes: 3, cap: 18, trips: 45, collisions: 0},
      {id: '4120', name: 'Chamart√≠n', lat: 40.4720, lon: -3.6844, bikes: 10, cap: 20, trips: 60, collisions: 1},
      {id: '5201', name: 'Malasa√±a', lat: 40.4259, lon: -3.7080, bikes: 6, cap: 15, trips: 80, collisions: 1}
    ];

    // Prepare map
    const map = L.map('map').setView([40.4168, -3.7038], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    // Marker layers and heat layers
    const stationLayer = L.layerGroup().addTo(map);
    let heatLayer = null;
    let routeLayer = L.layerGroup().addTo(map);

    // Utility: color by safety score
    function safetyScore(s){
      // score: higher = safer
      // heuristic: available ratio minus normalized collisions
      const avail = (s.bikes || 0) / (s.cap || 1); // 0..1
      const collFactor = Math.min(s.collisions || 0, 5)/5; // 0..1
      return avail - collFactor*0.6; // range approx [-0.6..1]
    }

    function safetyColor(score){
      if(score > 0.5) return '#1a9850'; // green
      if(score > 0.1) return '#ffd92f'; // yellow
      return '#ef4444'; // red
    }

    // Add station markers
    stations.forEach(s => {
      const score = safetyScore(s);
      const marker = L.circleMarker([s.lat, s.lon], {
        radius: 8, fillOpacity: 0.9, color: '#fff', weight:1, fillColor: safetyColor(score)
      }).addTo(stationLayer);
      marker.bindPopup(`<strong>${s.name} (${s.id})</strong><br/>Bikes: ${s.bikes}/${s.cap}<br/>Trips: ${s.trips}<br/>Collisions: ${s.collisions}<br/>Safety: ${(score).toFixed(2)}`);
      marker.on('click', ()=>{
        marker.openPopup();
      });
    });

    // Populate station list in sidebar
    const list = document.getElementById('stationList');
    stations.forEach(s => {
      const el = document.createElement('div'); el.className='station-item';
      const score = safetyScore(s);
      el.innerHTML = `<strong>${s.id} ‚Äî ${s.name}</strong>
        <div style="margin-top:6px;color:var(--muted)">
          Bikes: ${s.bikes}/${s.cap} &nbsp;¬∑&nbsp; Trips: ${s.trips} &nbsp;¬∑&nbsp; Collisions: ${s.collisions}
        </div>
        <div style="margin-top:8px;color:${safetyColor(score)}">Safety score: ${score.toFixed(2)}</div>`;
      el.addEventListener('click', ()=>{ map.flyTo([s.lat,s.lon],15); });
      list.appendChild(el);
    });

    // Build heat arrays
    const tripHeatPoints = stations.map(s => [s.lat, s.lon, Math.max(0.5, s.trips/50)]); // intensity scaled
    const collHeatPoints = stations.map(s => [s.lat, s.lon, Math.max(0.5, s.collisions)]);

    // Heat buttons
    document.getElementById('heatTripsBtn').addEventListener('click', ()=>{
      if(heatLayer) map.removeLayer(heatLayer);
      heatLayer = L.heatLayer(tripHeatPoints, {radius: 40, blur:25, maxZoom: 17}).addTo(map);
      document.getElementById('legend').textContent = 'Heat: trip density (darker = more trips)';
    });
    document.getElementById('heatCollBtn').addEventListener('click', ()=>{
      if(heatLayer) map.removeLayer(heatLayer);
      heatLayer = L.heatLayer(collHeatPoints, {radius: 50, blur:30, maxZoom: 17}).addTo(map);
      document.getElementById('legend').textContent = 'Heat: collisions (darker = more collisions)';
    });
    document.getElementById('clearHeatBtn').addEventListener('click', ()=>{
      if(heatLayer) map.removeLayer(heatLayer);
      heatLayer=null;
      document.getElementById('legend').textContent='Tip: toggle heatmap to inspect hotspots. Click station markers for details.';
    });

    // Get key stations
    const sol    = stations.find(s=>s.id==='1001');   // Puerta del Sol
    const plaza  = stations.find(s=>s.id==='1012');   // Plaza Mayor
    const atocha = stations.find(s=>s.id==='2030');   // Atocha
    const malas  = stations.find(s=>s.id==='5201');   // Malasa√±a

    // utility: haversine distance (km)
    function haversine(lat1,lon1,lat2,lon2){
      function toRad(v){return v*Math.PI/180}
      const R=6371;
      const dLat=toRad(lat2-lat1);
      const dLon=toRad(lon2-lon1);
      const a=Math.sin(dLat/2)*Math.sin(dLat/2)
            +Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2);
      const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
      return R*c;
    }

    function setRouteLegend(fromName, toName, distanceKm, avgSpeedKmh, note){
      const mins = Math.round((distanceKm/avgSpeedKmh)*60);
      const extra = note ? ` ‚Äî ${note}` : '';
      document.getElementById('legend').textContent =
        `Route: ${fromName} ‚Üí ${toName} ‚Äî approx ${distanceKm.toFixed(2)} km, ~${mins} min by bike${extra}`;
    }

    // ROUTES

    // 1) Direct Sol ‚Üí Plaza Mayor
    function showRouteSolPlazaDirect(){
      routeLayer.clearLayers();
      if(!sol || !plaza) return alert('Sol or Plaza Mayor not found in dataset');
      const coords = [[sol.lat,sol.lon],[plaza.lat,plaza.lon]];
      const poly = L.polyline(coords,{color:'#0b84ff',weight:4,opacity:0.9}).addTo(routeLayer);
      L.marker([sol.lat,sol.lon]).addTo(routeLayer).bindPopup(`<strong>${sol.name}</strong>`).openPopup();
      L.marker([plaza.lat,plaza.lon]).addTo(routeLayer).bindPopup(`<strong>${plaza.name}</strong>`);
      map.fitBounds(poly.getBounds().pad(0.4));
      const d = haversine(sol.lat,sol.lon,plaza.lat,plaza.lon);
      setRouteLegend(sol.name, plaza.name, d, 12, '(direct example)');
    }

    // 2) Scenic Sol ‚Üí Plaza Mayor via Malasa√±a
    function showRouteSolPlazaScenic(){
      routeLayer.clearLayers();
      if(!sol || !plaza || !malas) return alert('Needed stations (Sol/Plaza/Malasa√±a) not found in dataset');
      const coords = [
        [sol.lat,sol.lon],
        [malas.lat,malas.lon],
        [plaza.lat,plaza.lon]
      ];
      const poly = L.polyline(coords,{color:'#22c55e',weight:4,opacity:0.9,dashArray:'6,4'}).addTo(routeLayer);
      L.marker([sol.lat,sol.lon]).addTo(routeLayer).bindPopup(`<strong>${sol.name}</strong>`).openPopup();
      L.marker([malas.lat,malas.lon]).addTo(routeLayer).bindPopup(`<strong>${malas.name} (via)</strong>`);
      L.marker([plaza.lat,plaza.lon]).addTo(routeLayer).bindPopup(`<strong>${plaza.name}</strong>`);
      map.fitBounds(poly.getBounds().pad(0.4));

      // approximate total distance as sum of segments
      const d1 = haversine(sol.lat,sol.lon,malas.lat,malas.lon);
      const d2 = haversine(malas.lat,malas.lon,plaza.lat,plaza.lon);
      const dTotal = d1 + d2;
      setRouteLegend(sol.name, plaza.name, dTotal, 11, '(via Malasa√±a ‚Äî scenic detour)');
    }

    // 3) Direct Sol ‚Üí Atocha
    function showRouteSolAtocha(){
      routeLayer.clearLayers();
      if(!sol || !atocha) return alert('Sol or Atocha not found in dataset');
      const coords = [[sol.lat,sol.lon],[atocha.lat,atocha.lon]];
      const poly = L.polyline(coords,{color:'#f97316',weight:4,opacity:0.9}).addTo(routeLayer);
      L.marker([sol.lat,sol.lon]).addTo(routeLayer).bindPopup(`<strong>${sol.name}</strong>`).openPopup();
      L.marker([atocha.lat,atocha.lon]).addTo(routeLayer).bindPopup(`<strong>${atocha.name}</strong>`);
      map.fitBounds(poly.getBounds().pad(0.4));
      const d = haversine(sol.lat,sol.lon,atocha.lat,atocha.lon);
      setRouteLegend(sol.name, atocha.name, d, 14, '(direct link to major station)');
    }

    // Hook up route buttons
    document.getElementById('routeSolPlazaDirectBtn')
      .addEventListener('click', showRouteSolPlazaDirect);
    document.getElementById('routeSolPlazaScenicBtn')
      .addEventListener('click', showRouteSolPlazaScenic);
    document.getElementById('routeSolAtochaBtn')
      .addEventListener('click', showRouteSolAtocha);

    // Safe spot highlighting: markers with high safety score
    function highlightSafeSpots(){
      routeLayer.clearLayers(); // clear previous routes to focus on safe spots
      // find top 3 by safety score
      const ranked = stations.map(s=>({s,score:safetyScore(s)})).sort((a,b)=>b.score-a.score);
      const top = ranked.slice(0,3).map(r=>r.s);
      top.forEach(t=>{
        const m = L.circleMarker([t.lat,t.lon],{
          radius:14,fillColor:'#1a9850',color:'#fff',weight:2,fillOpacity:0.9
        }).addTo(routeLayer);
        setTimeout(()=>{ m.bindPopup(`<strong>Safe spot: ${t.name}</strong><br/>Safety ${(safetyScore(t)).toFixed(2)}`).openPopup(); }, 200);
        setTimeout(()=>{ map.flyTo([t.lat,t.lon],14); }, 600);
      });
      document.getElementById('legend').textContent =
        `Highlighted top ${top.length} safe spots (based on mock data)`;
    }
    document.getElementById('safeSpotsBtn').addEventListener('click', highlightSafeSpots);

    // Helpful: center map on Sol by default
    if (sol) {
      map.setView([sol.lat,sol.lon],14);
    }

  </script>

  <!-- Dark mode logic -->
  <script>
    (function(){
      const body = document.body;
      const btn = document.getElementById('themeToggle');
      const stored = localStorage.getItem('msm-theme');

      if(stored === 'dark'){
        body.classList.add('dark');
        if(btn) btn.textContent = '‚òÄÔ∏è Light';
      }

      if(btn){
        btn.addEventListener('click', ()=>{
          const isDark = body.classList.toggle('dark');
          localStorage.setItem('msm-theme', isDark ? 'dark' : 'light');
          btn.textContent = isDark ? '‚òÄÔ∏è Light' : 'üåô Dark';
        });
      }
    })();
  </script>
</body>
</html>
