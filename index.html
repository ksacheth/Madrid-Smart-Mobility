<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Madrid Smart Mobility ‚Äî Analytics Dashboard</title>
  
  <!-- Fonts & Libraries -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <style>
    /* --- CSS VARIABLES & THEME --- */
    :root {
      --bg: #f8fafc;
      --panel: #ffffff;
      --text: #0f172a;
      --text-muted: #64748b;
      --border: #e2e8f0;
      --primary: #3b82f6;
      --danger: #ef4444;
      --warning: #eab308;
      --success: #22c55e;
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }

    body.dark {
      --bg: #0f172a;
      --panel: #1e293b;
      --text: #f1f5f9;
      --text-muted: #94a3b8;
      --border: #334155;
      --primary: #38bdf8;
      --shadow: 0 10px 15px -3px rgb(0 0 0 / 0.5);
    }

    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* --- NAVBAR --- */
    nav {
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      padding: 0.75rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--shadow);
      z-index: 1001;
    }
    .brand { font-weight: 700; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }

    /* --- LAYOUT --- */
    .main-container { display: flex; flex: 1; overflow: hidden; }
    
    aside {
      width: 350px;
      background: var(--panel);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      z-index: 1000;
      padding: 1.25rem;
    }

    .sidebar-section { margin-bottom: 1.5rem; border-bottom: 1px solid var(--border); padding-bottom: 1rem; }
    h2 { font-size: 0.85rem; text-transform: uppercase; color: var(--text-muted); letter-spacing: 0.05em; margin-top: 0; }

    /* --- CONTROLS --- */
    button.btn {
      width: 100%;
      background: var(--panel);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 10px;
      border-radius: 6px;
      cursor: pointer;
      text-align: left;
      margin-bottom: 8px;
      font-size: 0.9rem;
      transition: all 0.2s;
    }
    button.btn:hover { border-color: var(--primary); color: var(--primary); background: var(--bg); }
    
    select {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text);
      margin-bottom: 8px;
    }

    .stat-box {
      background: var(--bg);
      padding: 12px;
      border-radius: 8px;
      text-align: center;
      border: 1px solid var(--border);
    }
    .stat-num { font-size: 1.5rem; font-weight: 700; }
    .stat-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; }

    /* --- MAP --- */
    #map-wrapper { flex: 1; position: relative; }
    #map { width: 100%; height: 100%; }

    /* --- POPUP STYLING (Matches Screenshot) --- */
    .leaflet-popup-content-wrapper {
      border-radius: 8px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
      padding: 0;
      overflow: hidden;
    }
    .leaflet-popup-content {
      margin: 16px 20px;
      font-family: 'Inter', sans-serif;
      line-height: 1.5;
      color: #333;
      font-size: 13px;
      width: 280px !important;
    }
    
    .acc-popup .header { margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid #eee; }
    .acc-popup .title { font-weight: 700; font-size: 15px; color: #111; margin-bottom: 2px; }
    .acc-popup .time { font-weight: 600; font-size: 13px; color: #444; }
    .acc-popup .loc { font-size: 12px; color: #666; text-transform: uppercase; margin-top: 4px; }
    
    .acc-row { margin-bottom: 4px; display: flex; align-items: baseline; }
    .acc-label { font-weight: 700; color: #111; margin-right: 6px; min-width: 65px; }
    .acc-val { color: #333; }

    /* --- LEGEND --- */
    .legend {
      position: absolute; bottom: 24px; right: 24px;
      background: var(--panel); padding: 12px; border-radius: 8px;
      font-size: 12px; border: 1px solid var(--border); z-index: 1000;
      box-shadow: var(--shadow);
    }
    .dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }

    @media (max-width: 768px) {
      .main-container { flex-direction: column; }
      aside { width: 100%; height: 45%; order: 2; }
      #map-wrapper { height: 55%; order: 1; }
    }
  </style>
</head>
<body>

  <nav>
    <div class="brand">üö≤ Madrid Smart Mobility</div>
    <button id="themeToggle" style="background:transparent; border:1px solid var(--border); padding:6px 12px; border-radius:20px; cursor:pointer; color:var(--text)">üåô Dark Mode</button>
  </nav>

  <div class="main-container">
    <aside>
      <!-- Stats -->
      <div class="sidebar-section">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <div class="stat-box">
            <div class="stat-num" style="color:var(--primary)" id="stat-stations">0</div>
            <div class="stat-label">Active Stations</div>
          </div>
          <div class="stat-box">
            <div class="stat-num" style="color:var(--danger)" id="stat-accidents">0</div>
            <div class="stat-label">Recorded Incidents</div>
          </div>
        </div>
      </div>

      <!-- Controls -->
      <div class="sidebar-section">
        <h2>Map Layers</h2>
        <button class="btn" id="btn-heat">üî• Toggle Heatmap (Accidents)</button>
        <button class="btn" id="btn-stations">üö≤ Toggle Stations</button>
        <button class="btn" id="btn-reset" style="color:var(--text-muted)">‚úï Reset View</button>
      </div>

      <!-- Filters -->
      <div class="sidebar-section">
        <h2>Accident Filter</h2>
        <select id="weatherFilter">
          <option value="all">Weather: All Conditions</option>
          <option value="Lluvia">Rain (Lluvia)</option>
          <option value="Despejado">Clear (Despejado)</option>
          <option value="Nublado">Cloudy (Nublado)</option>
        </select>
        <div style="font-size:12px; color:var(--text-muted); margin-top:5px;">
          Tip: Click on red/yellow markers to view the detailed accident report.
        </div>
      </div>

      <div style="font-size:11px; color:var(--text-muted); margin-top:auto;">
        Data source: Mock Stations + Provided Accident Log (EPSG:25830)
      </div>
    </aside>

    <div id="map-wrapper">
      <div id="map"></div>
      <div class="legend">
        <div style="margin-bottom:4px; font-weight:700">Accident Severity</div>
        <div><span class="dot" style="background:#ef4444"></span>Serious (Ingreso 24h)</div>
        <div><span class="dot" style="background:#eab308"></span>Minor (Asistencia)</div>
        <div><span class="dot" style="background:#22c55e"></span>None (Sin asistencia)</div>
        <hr style="border:0; border-top:1px solid var(--border); margin:8px 0;">
        <div style="margin-bottom:4px; font-weight:700">Stations</div>
        <div><span class="dot" style="background:#3b82f6"></span>Bike Station</div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.7.5/proj4.js"></script>

  <script>
    // --- 1. DATA & CONFIG ---
    
    // Define Coordinate System (UTM Zone 30N to WGS84)
    proj4.defs("EPSG:25830","+proj=utm +zone=30 +ellps=GRS80 +units=m +no_defs");

    // Mock Station Data
    const stations = [
      {id: '1001', name: 'Puerta del Sol', lat: 40.416775, lon: -3.703790, bikes: 8, cap: 25},
      {id: '1012', name: 'Plaza Mayor', lat: 40.415524, lon: -3.707412, bikes: 5, cap: 20},
      {id: '2030', name: 'Atocha Renfe', lat: 40.406876, lon: -3.690486, bikes: 18, cap: 30},
      {id: '3120', name: 'Arg√ºelles', lat: 40.432167, lon: -3.717857, bikes: 3, cap: 15},
      {id: '5201', name: 'Malasa√±a', lat: 40.4259, lon: -3.7080, bikes: 6, cap: 15}
    ];

    // Detailed Accident Data (Parsed from your request)
    const accidentsRaw = [
      { exp:"2023S040309", date:"2024-02-15", time:"14:05", loc:"CALL. TESORO / CALL. MINAS", dist:"Centro", type:"Colisi√≥n fronto-lateral", meteo:"Lluvia d√©bil", veh:"Bicicleta", pers:"Conductor", age:"25-29", sex:"Hombre", lesion:"Asistencia sanitaria s√≥lo en el lugar", x:440123, y:4475170 },
      { exp:"2024S000027", date:"2024-01-01", time:"16:30", loc:"CALL. ALEJANDRO MORAN / CALL. GENERAL RICARDOS", dist:"Carabanchel", type:"Colisi√≥n fronto-lateral", meteo:"Despejado", veh:"Bicicleta EPAC (pedaleo asistido)", pers:"Conductor", age:"25-29", sex:"Hombre", lesion:"Asistencia sanitaria s√≥lo en el lugar", x:437732, y:4470986 },
      { exp:"2024S000058", date:"2024-01-02", time:"09:45", loc:"GTA. LOZARES / AVDA. REAL DE PINTO", dist:"Villaverde", type:"Ca√≠da", meteo:"Despejado", veh:"Bicicleta", pers:"Conductor", age:"70-74", sex:"Hombre", lesion:"Ingreso inferior o igual a 24 horas", x:439897, y:4465733 },
      { exp:"2024S000081-C", date:"2024-01-02", time:"19:30", loc:"CALL. HORTALEZA, 96", dist:"Centro", type:"Atropello a persona", meteo:"Nublado", veh:"Bicicleta EPAC (pedaleo asistido)", pers:"Conductor", age:"30-34", sex:"Hombre", lesion:"Sin asistencia sanitaria", x:440785, y:4475122 },
      { exp:"2024S000081-P", date:"2024-01-02", time:"19:30", loc:"CALL. HORTALEZA, 96", dist:"Centro", type:"Atropello a persona", meteo:"Nublado", veh:"Bicicleta EPAC (pedaleo asistido)", pers:"Peat√≥n", age:"65-69", sex:"Hombre", lesion:"Ingreso inferior o igual a 24 horas", x:440785, y:4475122 },
      { exp:"2024S000108", date:"2024-01-03", time:"08:30", loc:"CALL. BRAVO MURILLO, 154", dist:"Tetu√°n", type:"Alcance", meteo:"LLuvia intensa", veh:"Bicicleta EPAC (pedaleo asistido)", pers:"Conductor", age:"35-39", sex:"Hombre", lesion:"Asistencia sanitaria s√≥lo en el lugar", x:440364, y:4478099 }
    ];

    // --- 2. MAP INITIALIZATION ---
    const map = L.map('map', { zoomControl: false }).setView([40.4168, -3.7038], 13);
    L.control.zoom({ position: 'topright' }).addTo(map);

    // Tile Layers
    const lightTiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap &copy; CartoDB' });
    const darkTiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap &copy; CartoDB' });
    lightTiles.addTo(map);

    // Layer Groups
    const stationLayer = L.layerGroup().addTo(map);
    const accidentLayer = L.layerGroup().addTo(map);
    let heatLayer = null;

    // --- 3. HELPERS ---
    
    // Determine color based on injury severity
    function getSeverityColor(l) {
      if(l.includes("Ingreso")) return "#ef4444"; // Red (Serious)
      if(l.includes("Sin asistencia")) return "#22c55e"; // Green (None)
      return "#eab308"; // Yellow (Minor)
    }

    // Shorten text for display
    function formatLesion(l) {
      if(l.includes("Ingreso")) return "Ingreso 24h";
      if(l.includes("Sin asistencia")) return "Sin asistencia";
      if(l.includes("Asistencia")) return "Asistencia en lugar";
      return l;
    }

    function formatVehicle(v) {
      if(v.includes("EPAC")) return "electric bicycle";
      return "bicycle";
    }

    // --- 4. RENDER FUNCTIONS ---

    function renderStations() {
      stationLayer.clearLayers();
      stations.forEach(s => {
        L.circleMarker([s.lat, s.lon], {
          radius: 6, color: '#fff', weight: 1, fillColor: '#3b82f6', fillOpacity: 0.9
        }).bindPopup(`<b>${s.name}</b><br>Bikes available: ${s.bikes}/${s.cap}`)
        .addTo(stationLayer);
      });
      document.getElementById('stat-stations').innerText = stations.length;
    }

    function renderAccidents(weatherFilter = "all") {
      accidentLayer.clearLayers();
      
      const filtered = accidentsRaw.filter(a => {
        return weatherFilter === "all" || a.meteo.toLowerCase().includes(weatherFilter.toLowerCase());
      });

      filtered.forEach(a => {
        // Convert Coords
        const [lon, lat] = proj4("EPSG:25830", "EPSG:4326", [a.x, a.y]);
        // Offset slighty if it's the pedestrian in the same accident to avoid perfect overlap
        const offsetLat = (a.pers === 'Peat√≥n') ? lat + 0.00005 : lat;

        const color = getSeverityColor(a.lesion);
        const vehStr = formatVehicle(a.veh);
        const lesStr = formatLesion(a.lesion);

        const marker = L.circleMarker([offsetLat, lon], {
          radius: 9, fillColor: color, color: '#fff', weight: 2, opacity: 1, fillOpacity: 0.9
        }).addTo(accidentLayer);

        // POPUP HTML (Matches Screenshot)
        const popupHTML = `
          <div class="acc-popup">
            <div class="header">
              <div class="title">Accidente ${a.exp}</div>
              <div class="time">${a.date} ${a.time}</div>
              <div class="loc">${a.loc}</div>
            </div>
            <div class="acc-row"><span class="acc-label">Tipo:</span> <span class="acc-val">${a.type}</span></div>
            <div class="acc-row"><span class="acc-label">Distrito:</span> <span class="acc-val">${a.dist}</span></div>
            <div class="acc-row"><span class="acc-label">Veh√≠culo:</span> <span class="acc-val">${vehStr}</span></div>
            <div class="acc-row"><span class="acc-label">Persona:</span> <span class="acc-val">${a.pers} (${a.age})</span></div>
            <div class="acc-row"><span class="acc-label">Meteo:</span> <span class="acc-val">${a.meteo}</span></div>
            <div class="acc-row"><span class="acc-label">Lesividad:</span> <span class="acc-val" style="color:${color}; font-weight:700">${lesStr}</span></div>
          </div>
        `;
        marker.bindPopup(popupHTML);
      });

      document.getElementById('stat-accidents').innerText = filtered.length;
    }

    // --- 5. INTERACTIONS ---

    // Toggle Heatmap
    document.getElementById('btn-heat').addEventListener('click', () => {
      if(heatLayer) {
        map.removeLayer(heatLayer);
        heatLayer = null;
      } else {
        const points = accidentsRaw.map(a => {
          const [lon, lat] = proj4("EPSG:25830", "EPSG:4326", [a.x, a.y]);
          return [lat, lon, 1]; // weight 1
        });
        heatLayer = L.heatLayer(points, { radius: 35, blur: 20, maxZoom: 15 }).addTo(map);
      }
    });

    // Toggle Stations
    document.getElementById('btn-stations').addEventListener('click', () => {
      if(map.hasLayer(stationLayer)) map.removeLayer(stationLayer);
      else map.addLayer(stationLayer);
    });

    // Reset
    document.getElementById('btn-reset').addEventListener('click', () => {
      if(heatLayer) { map.removeLayer(heatLayer); heatLayer = null; }
      if(!map.hasLayer(stationLayer)) map.addLayer(stationLayer);
      map.setView([40.4168, -3.7038], 13);
      document.getElementById('weatherFilter').value = "all";
      renderAccidents("all");
    });

    // Filter Change
    document.getElementById('weatherFilter').addEventListener('change', (e) => {
      renderAccidents(e.target.value);
    });

    // Dark Mode Toggle
    document.getElementById('themeToggle').addEventListener('click', function() {
      const isDark = document.body.classList.toggle('dark');
      this.innerText = isDark ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';
      if(isDark) {
        map.removeLayer(lightTiles); darkTiles.addTo(map);
      } else {
        map.removeLayer(darkTiles); lightTiles.addTo(map);
      }
    });

    // --- 6. INITIALIZE ---
    renderStations();
    renderAccidents();

  </script>
</body>
</html>
