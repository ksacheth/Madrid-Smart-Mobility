<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Madrid Smart Mobility ‚Äî Analytics Dashboard</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <style>
      :root {
        --bg: #f8fafc;
        --panel: #ffffff;
        --text: #0f172a;
        --text-muted: #64748b;
        --border: #e2e8f0;
        --primary: #3b82f6;
        --primary-hover: #2563eb;
        --danger: #ef4444;
        --success: #22c55e;
        --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1),
          0 2px 4px -2px rgb(0 0 0 / 0.1);
      }

      body.dark {
        --bg: #0f172a;
        --panel: #1e293b;
        --text: #f1f5f9;
        --text-muted: #94a3b8;
        --border: #334155;
        --primary: #38bdf8;
        --primary-hover: #0ea5e9;
        --shadow: 0 10px 15px -3px rgb(0 0 0 / 0.5);
      }

      * {
        box-sizing: border-box;
        transition: background-color 0.2s, color 0.2s;
      }

      body {
        font-family: "Inter", sans-serif;
        margin: 0;
        background: var(--bg);
        color: var(--text);
        height: 100vh;
        display: flex;
        flex-direction: column;
      }

      /* Navbar */
      nav {
        background: var(--panel);
        border-bottom: 1px solid var(--border);
        padding: 0.75rem 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 1001;
        box-shadow: var(--shadow);
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 700;
        font-size: 1.1rem;
      }

      .brand-icon {
        width: 32px;
        height: 32px;
        background: var(--primary);
        color: white;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
      }

      /* Main Layout */
      .main-container {
        display: flex;
        flex: 1;
        overflow: hidden;
      }

      /* Sidebar */
      aside {
        width: 360px;
        background: var(--panel);
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        z-index: 1000;
      }

      .sidebar-section {
        padding: 1.25rem;
        border-bottom: 1px solid var(--border);
      }

      h2 {
        margin: 0 0 1rem 0;
        font-size: 0.95rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted);
      }
      h3 {
        margin: 0 0 0.5rem 0;
        font-size: 1rem;
      }

      /* Controls Grid */
      .control-grid {
        display: grid;
        gap: 0.75rem;
      }

      button.btn {
        background: var(--panel);
        border: 1px solid var(--border);
        color: var(--text);
        padding: 0.6rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 500;
        text-align: left;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
      }

      button.btn:hover {
        border-color: var(--primary);
        color: var(--primary);
        background: var(--bg);
      }
      button.btn.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
      }

      .select-wrap {
        margin-bottom: 1rem;
      }
      select {
        width: 100%;
        padding: 8px;
        border-radius: 6px;
        border: 1px solid var(--border);
        background: var(--bg);
        color: var(--text);
      }

      /* Station List */
      .stat-card {
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 8px;
        cursor: pointer;
      }
      .stat-card:hover {
        border-color: var(--primary);
      }
      .stat-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 4px;
        font-weight: 600;
        font-size: 0.9rem;
      }
      .stat-row {
        display: flex;
        justify-content: space-between;
        font-size: 0.8rem;
        color: var(--text-muted);
      }
      .score-badge {
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: bold;
        color: white;
      }

      /* Map Area */
      #map-wrapper {
        flex: 1;
        position: relative;
      }
      #map {
        width: 100%;
        height: 100%;
      }

      /* Custom Popup Styling */
      .leaflet-popup-content-wrapper {
        background: var(--panel);
        color: var(--text);
        border-radius: 8px;
        box-shadow: var(--shadow);
        font-family: "Inter", sans-serif;
      }

      .leaflet-popup-content {
        margin: 0;
        min-width: 280px;
      }

      .accident-popup {
        padding: 12px;
      }

      .accident-popup h3 {
        margin: 0 0 8px 0;
        font-size: 14px;
        font-weight: 700;
        color: var(--text);
      }

      .accident-popup .accident-detail {
        margin: 6px 0;
        font-size: 13px;
        display: flex;
        gap: 8px;
      }

      .accident-popup .accident-detail strong {
        min-width: 90px;
        color: var(--text-muted);
        font-weight: 600;
      }

      .accident-popup .accident-detail span {
        color: var(--text);
      }

      /* Map Overlays */
      .map-overlay-legend {
        position: absolute;
        bottom: 24px;
        right: 24px;
        background: var(--panel);
        padding: 12px 16px;
        border-radius: 8px;
        box-shadow: var(--shadow);
        z-index: 1000;
        font-size: 0.85rem;
        max-width: 300px;
        border: 1px solid var(--border);
      }

      /* Utility */
      .badge {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 6px;
      }
      .badge.red {
        background: var(--danger);
      }
      .badge.green {
        background: var(--success);
      }
      .badge.blue {
        background: var(--primary);
      }

      @media (max-width: 768px) {
        .main-container {
          flex-direction: column;
        }
        aside {
          width: 100%;
          height: 40%;
          order: 2;
        }
        #map-wrapper {
          height: 60%;
          order: 1;
        }
      }
    </style>
  </head>
  <body>
    <nav>
      <div class="brand">
        <div class="brand-icon">üö≤</div>
        <div>
          Madrid Smart Mobility
          <div
            style="
              font-size: 0.75rem;
              color: var(--text-muted);
              font-weight: 400;
            "
          >
            Analytics Dashboard
          </div>
        </div>
      </div>
      <button id="themeToggle" class="btn">üåô Dark Mode</button>
    </nav>

    <div class="main-container">
      <aside>
        <!-- Stats Summary -->
        <div class="sidebar-section">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px">
            <div
              style="
                background: var(--bg);
                padding: 10px;
                border-radius: 8px;
                text-align: center;
              "
            >
              <div
                style="
                  font-size: 1.5rem;
                  font-weight: 700;
                  color: var(--primary);
                "
                id="stat-stations"
              >
                0
              </div>
              <div style="font-size: 0.75rem; color: var(--text-muted)">
                Stations Monitored
              </div>
            </div>
            <div
              style="
                background: var(--bg);
                padding: 10px;
                border-radius: 8px;
                text-align: center;
              "
            >
              <div
                style="
                  font-size: 1.5rem;
                  font-weight: 700;
                  color: var(--danger);
                "
                id="stat-accidents"
              >
                0
              </div>
              <div style="font-size: 0.75rem; color: var(--text-muted)">
                Recent Incidents
              </div>
            </div>
          </div>
        </div>

        <!-- Visualizations -->
        <div class="sidebar-section">
          <h2>Visualization Layers</h2>
          <div class="control-grid">
            <button class="btn" id="btn-heat-trips">
              üìä Trip Density Heatmap
            </button>
            <button class="btn" id="btn-heat-coll">üî• Collision Heatmap</button>
            <button class="btn" id="btn-safe-spots">
              üõ°Ô∏è Highlight Safe Spots
            </button>
            <button
              class="btn"
              id="btn-reset-map"
              style="color: var(--text-muted)"
            >
              ‚úï Clear Layers
            </button>
          </div>
        </div>

        <!-- Accident Filters -->
        <div class="sidebar-section">
          <h2>Accident Data Filter</h2>
          <div class="select-wrap">
            <select id="weatherFilter">
              <option value="all">Weather: All Conditions</option>
              <option value="Despejado">Clear (Despejado)</option>
              <option value="Lluvia">Rain (Lluvia)</option>
              <option value="Nublado">Cloudy (Nublado)</option>
            </select>
          </div>
          <div class="select-wrap">
            <select id="ageFilter">
              <option value="all">Age: All</option>
              <option value="De 10 a 14 a√±os">De 10 a 14 a√±os</option>
              <option value="De 15 a 17 a√±os">De 15 a 17 a√±os</option>
              <option value="De 18 a 20 a√±os">De 18 a 20 a√±os</option>
              <option value="De 21 a 24 a√±os">De 21 a 24 a√±os</option>
              <option value="De 25 a 29 a√±os">De 25 a 29 a√±os</option>
              <option value="De 30 a 34 a√±os">De 30 a 34 a√±os</option>
              <option value="De 35 a 39 a√±os">De 35 a 39 a√±os</option>
              <option value="De 40 a 44 a√±os">De 40 a 44 a√±os</option>
              <option value="De 45 a 49 a√±os">De 45 a 49 a√±os</option>
              <option value="De 50 a 54 a√±os">De 50 a 54 a√±os</option>
              <option value="De 55 a 59 a√±os">De 55 a 59 a√±os</option>
              <option value="De 60 a 64 a√±os">De 60 a 64 a√±os</option>
              <option value="De 65 a 69 a√±os">De 65 a 69 a√±os</option>
              <option value="De 70 a 74 a√±os">De 70 a 74 a√±os</option>
              <option value="M√°s de 74 a√±os">M√°s de 74 a√±os</option>
              <option value="Desconocido">Desconocido</option>
            </select>
          </div>
          <div style="font-size: 0.75rem; color: var(--text-muted)">
            <span class="badge red"></span>Serious Injury
            <span class="badge" style="background: #facc15"></span>Minor Injury
            <span class="badge green"></span>No Injury
          </div>
        </div>

        <!-- Routes -->
        <div class="sidebar-section">
          <h2>Example Routes</h2>
          <div class="control-grid">
            <button class="btn" id="route-sol-plaza">
              Direct: Sol ‚Üí Plaza Mayor
            </button>
            <button class="btn" id="route-sol-plaza-scenic">
              Scenic: Sol ‚Üí Plaza Mayor (via Malasa√±a)
            </button>
            <button class="btn" id="route-sol-atocha">
              Commute: Sol ‚Üí Atocha
            </button>
          </div>
        </div>

        <!-- Station List -->
        <div class="sidebar-section" style="border-bottom: none">
          <h2>Station Status</h2>
          <div id="station-list"></div>
        </div>
      </aside>

      <div id="map-wrapper">
        <div id="map"></div>
        <div class="map-overlay-legend" id="legend">
          Select a layer or route to see details here.
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.7.5/proj4.js"></script>

    <script>
      // --- 1. Configuration & Mock Data ---
      proj4.defs(
        "EPSG:25830",
        "+proj=utm +zone=30 +ellps=GRS80 +units=m +no_defs"
      );

      const stations = [
        {
          id: "1001",
          name: "Puerta del Sol",
          lat: 40.416775,
          lon: -3.70379,
          bikes: 8,
          cap: 25,
          trips: 150,
          collisions: 1,
        },
        {
          id: "1012",
          name: "Plaza Mayor",
          lat: 40.415524,
          lon: -3.707412,
          bikes: 5,
          cap: 20,
          trips: 110,
          collisions: 0,
        },
        {
          id: "2030",
          name: "Atocha Renfe",
          lat: 40.406876,
          lon: -3.690486,
          bikes: 18,
          cap: 30,
          trips: 240,
          collisions: 3,
        },
        {
          id: "3120",
          name: "Arg√ºelles",
          lat: 40.432167,
          lon: -3.717857,
          bikes: 3,
          cap: 15,
          trips: 45,
          collisions: 0,
        },
        {
          id: "4120",
          name: "Chamart√≠n",
          lat: 40.472,
          lon: -3.6844,
          bikes: 10,
          cap: 25,
          trips: 80,
          collisions: 1,
        },
        {
          id: "5201",
          name: "Malasa√±a",
          lat: 40.4259,
          lon: -3.708,
          bikes: 6,
          cap: 15,
          trips: 95,
          collisions: 1,
        },
      ];

      const vehicleLabelMap = {
        bicycle: "Bicicleta",
        "electric bicycle": "Bicicleta el√©ctrica",
      };

      function normalizeVehicle(type = "") {
        const key = type.toLowerCase();
        return vehicleLabelMap[key] || type;
      }

      function formatLocation(localizacion = "", numero = "") {
        if (!numero || numero === "0") return localizacion;
        const trimmed = String(numero).trim();
        if (localizacion.toLowerCase().includes(trimmed.toLowerCase())) {
          return localizacion;
        }
        return `${localizacion}, ${trimmed}`;
      }

      const accidentDataset = [
        {
          expediente: "2023S040309",
          fecha: "2024-02-15",
          hora: "14:05:00",
          localizacion: "CALL. TESORO / CALL. MINAS",
          numero: "18",
          distrito: "Centro",
          estado_meteorologico: "Lluvia d√©bil",
          tipo_accidente: "Colisi√≥n fronto-lateral",
          tipo_vehiculo: "bicycle",
          tipo_persona: "Conductor",
          rango_edad: "De 25 a 29 a√±os",
          sexo: "Hombre",
          lesividad: "Asistencia sanitaria s√≥lo en el lugar del accidente",
          coordenada_x_utm: 440123,
          coordenada_y_utm: 4475170,
          positiva_alcohol: false,
          positiva_droga: false,
        },
        {
          expediente: "2024S000027",
          fecha: "2024-01-01",
          hora: "16:30:00",
          localizacion: "CALL. ALEJANDRO MORAN / CALL. GENERAL RICARDOS",
          numero: "2",
          distrito: "Carabanchel",
          estado_meteorologico: "Despejado",
          tipo_accidente: "Colisi√≥n fronto-lateral",
          tipo_vehiculo: "electric bicycle",
          tipo_persona: "Conductor",
          rango_edad: "De 25 a 29 a√±os",
          sexo: "Hombre",
          lesividad: "Asistencia sanitaria s√≥lo en el lugar del accidente",
          coordenada_x_utm: 437732,
          coordenada_y_utm: 4470986,
          positiva_alcohol: false,
          positiva_droga: false,
        },
        {
          expediente: "2024S000058",
          fecha: "2024-01-02",
          hora: "09:45:00",
          localizacion: "GTA. LOZARES / AVDA. REAL DE PINTO",
          numero: "0",
          distrito: "Villaverde",
          estado_meteorologico: "Despejado",
          tipo_accidente: "Ca√≠da",
          tipo_vehiculo: "bicycle",
          tipo_persona: "Conductor",
          rango_edad: "De 70 a 74 a√±os",
          sexo: "Hombre",
          lesividad: "Ingreso inferior o igual a 24 horas",
          coordenada_x_utm: 439897,
          coordenada_y_utm: 4465733,
          positiva_alcohol: false,
          positiva_droga: false,
        },
        {
          expediente: "2024S000081",
          fecha: "2024-01-02",
          hora: "19:30:00",
          localizacion: "CALL. HORTALEZA, 96",
          numero: "96",
          distrito: "Centro",
          estado_meteorologico: "Nublado",
          tipo_accidente: "Atropello a persona",
          tipo_vehiculo: "electric bicycle",
          tipo_persona: "Conductor",
          rango_edad: "De 30 a 34 a√±os",
          sexo: "Hombre",
          lesividad: "Sin asistencia sanitaria",
          coordenada_x_utm: 440785,
          coordenada_y_utm: 4475122,
          positiva_alcohol: false,
          positiva_droga: false,
        },
        {
          expediente: "2024S000081",
          fecha: "2024-01-02",
          hora: "19:30:00",
          localizacion: "CALL. HORTALEZA, 96",
          numero: "96",
          distrito: "Centro",
          estado_meteorologico: "Nublado",
          tipo_accidente: "Atropello a persona",
          tipo_vehiculo: "electric bicycle",
          tipo_persona: "Peat√≥n",
          rango_edad: "De 65 a 69 a√±os",
          sexo: "Hombre",
          lesividad: "Ingreso inferior o igual a 24 horas",
          coordenada_x_utm: 440785,
          coordenada_y_utm: 4475122,
          positiva_alcohol: false,
          positiva_droga: false,
        },
        {
          expediente: "2024S000108",
          fecha: "2024-01-03",
          hora: "08:30:00",
          localizacion: "CALL. BRAVO MURILLO, 154",
          numero: "154",
          distrito: "Tetu√°n",
          estado_meteorologico: "LLuvia intensa",
          tipo_accidente: "Alcance",
          tipo_vehiculo: "electric bicycle",
          tipo_persona: "Conductor",
          rango_edad: "De 35 a 39 a√±os",
          sexo: "Hombre",
          lesividad: "Asistencia sanitaria s√≥lo en el lugar del accidente",
          coordenada_x_utm: 440364,
          coordenada_y_utm: 4478099,
          positiva_alcohol: false,
          positiva_droga: false,
        },
        {
          expediente: "2024S000168",
          fecha: "2024-01-03",
          hora: "11:30:00",
          localizacion: "PASEO. EXTREMADURA, 21",
          numero: "21",
          distrito: "Latina",
          estado_meteorologico: "Lluvia d√©bil",
          tipo_accidente: "Ca√≠da",
          tipo_vehiculo: "bicycle",
          tipo_persona: "Conductor",
          rango_edad: "De 25 a 29 a√±os",
          sexo: "Mujer",
          lesividad: "Asistencia sanitaria s√≥lo en el lugar del accidente",
          coordenada_x_utm: 438247,
          coordenada_y_utm: 4473924,
          positiva_alcohol: false,
          positiva_droga: false,
        },
        {
          expediente: "2024S000274",
          fecha: "2024-01-04",
          hora: "20:30:00",
          localizacion: "CALL. NUESTRA SE√ëORA DE VALVERDE / CALL. ISLA PARAGUA",
          numero: "37",
          distrito: "Fuencarral-El Pardo",
          estado_meteorologico: "LLuvia intensa",
          tipo_accidente: "Colisi√≥n fronto-lateral",
          tipo_vehiculo: "bicycle",
          tipo_persona: "Conductor",
          rango_edad: "De 30 a 34 a√±os",
          sexo: "Hombre",
          lesividad: "Ingreso inferior o igual a 24 horas",
          coordenada_x_utm: 441783,
          coordenada_y_utm: 4482707,
          positiva_alcohol: false,
          positiva_droga: false,
        },
        {
          expediente: "2024S000275",
          fecha: "2024-01-04",
          hora: "20:05:00",
          localizacion: "CALL. SERRANO / CALL. CONDE DE ARANDA",
          numero: "10",
          distrito: "Salamanca",
          estado_meteorologico: "Lluvia d√©bil",
          tipo_accidente: "Ca√≠da",
          tipo_vehiculo: "electric bicycle",
          tipo_persona: "Conductor",
          rango_edad: "De 55 a 59 a√±os",
          sexo: "Hombre",
          lesividad: "Ingreso superior a 24 horas",
          coordenada_x_utm: 441603,
          coordenada_y_utm: 4474805,
          positiva_alcohol: false,
          positiva_droga: false,
        },
        {
          expediente: "2024S000361",
          fecha: "2024-01-06",
          hora: "00:45:00",
          localizacion: "CALL. ALCALA / CALL. JULIO CAMBA",
          numero: "200A",
          distrito: "Salamanca",
          estado_meteorologico: "Despejado",
          tipo_accidente: "Alcance",
          tipo_vehiculo: "electric bicycle",
          tipo_persona: "Conductor",
          rango_edad: "De 21 a 24 a√±os",
          sexo: "Hombre",
          lesividad: "Ingreso superior a 24 horas",
          coordenada_x_utm: 443677,
          coordenada_y_utm: 4475741,
          positiva_alcohol: false,
          positiva_droga: false,
        },
        {
          expediente: "2024S000389",
          fecha: "2024-01-06",
          hora: "13:08:00",
          localizacion: "CALL. ALEJANDRO MORAN / CALL. JUAN FRANCISCO",
          numero: "11",
          distrito: "Carabanchel",
          estado_meteorologico: "Despejado",
          tipo_accidente: "Colisi√≥n fronto-lateral",
          tipo_vehiculo: "bicycle",
          tipo_persona: "Conductor",
          rango_edad: "De 21 a 24 a√±os",
          sexo: "Hombre",
          lesividad: "Asistencia sanitaria s√≥lo en el lugar del accidente",
          coordenada_x_utm: 437784,
          coordenada_y_utm: 4470932,
          positiva_alcohol: false,
          positiva_droga: false,
        },
        {
          expediente: "2024S000469",
          fecha: "2024-01-07",
          hora: "13:15:00",
          localizacion: "CTRA. TELEFERICO, 1",
          numero: "1",
          distrito: "Moncloa-Aravaca",
          estado_meteorologico: "Despejado",
          tipo_accidente: "Ca√≠da",
          tipo_vehiculo: "bicycle",
          tipo_persona: "Conductor",
          rango_edad: "De 10 a 14 a√±os",
          sexo: "Hombre",
          lesividad: "Asistencia sanitaria ambulatoria con posterioridad",
          coordenada_x_utm: 435993,
          coordenada_y_utm: 4474892,
          positiva_alcohol: false,
          positiva_droga: false,
        },
        {
          expediente: "2024S000469",
          fecha: "2024-01-07",
          hora: "13:15:00",
          localizacion: "CTRA. TELEFERICO, 1",
          numero: "1",
          distrito: "Moncloa-Aravaca",
          estado_meteorologico: "Despejado",
          tipo_accidente: "Ca√≠da",
          tipo_vehiculo: "bicycle",
          tipo_persona: "Conductor",
          rango_edad: "De 18 a 20 a√±os",
          sexo: "Hombre",
          lesividad: "Sin asistencia sanitaria",
          coordenada_x_utm: 435993,
          coordenada_y_utm: 4474892,
          positiva_alcohol: false,
          positiva_droga: false,
        },
        {
          expediente: "2024S000511",
          fecha: "2024-01-08",
          hora: "11:00:00",
          localizacion: "CALL. ALCALA, 265",
          numero: "265",
          distrito: "Ciudad Lineal",
          estado_meteorologico: "Despejado",
          tipo_accidente: "Colisi√≥n lateral",
          tipo_vehiculo: "bicycle",
          tipo_persona: "Conductor",
          rango_edad: "De 15 a 17 a√±os",
          sexo: "Hombre",
          lesividad: "Sin asistencia sanitaria",
          coordenada_x_utm: 444242,
          coordenada_y_utm: 4475898,
          positiva_alcohol: false,
          positiva_droga: false,
        },
        {
          expediente: "2024S000682",
          fecha: "2024-01-09",
          hora: "16:20:00",
          localizacion: "CALL. AYALA, 1",
          numero: "1",
          distrito: "Salamanca",
          estado_meteorologico: "Despejado",
          tipo_accidente: "Alcance",
          tipo_vehiculo: "electric bicycle",
          tipo_persona: "Conductor",
          rango_edad: "De 25 a 29 a√±os",
          sexo: "Mujer",
          lesividad:
            "Asistencia sanitaria inmediata en centro de salud o mutua",
          coordenada_x_utm: 441553,
          coordenada_y_utm: 4475486,
          positiva_alcohol: false,
          positiva_droga: false,
        },
        {
          expediente: "2024S000803",
          fecha: "2024-01-10",
          hora: "08:15:00",
          localizacion: "PASEO. PONTONES, 18",
          numero: "18",
          distrito: "Arganzuela",
          estado_meteorologico: "Nublado",
          tipo_accidente: "Colisi√≥n fronto-lateral",
          tipo_vehiculo: "electric bicycle",
          tipo_persona: "Conductor",
          rango_edad: "De 15 a 17 a√±os",
          sexo: "Mujer",
          lesividad: "Ingreso inferior o igual a 24 horas",
          coordenada_x_utm: 439123,
          coordenada_y_utm: 4472870,
          positiva_alcohol: false,
          positiva_droga: false,
        },
        {
          expediente: "2024S000909",
          fecha: "2024-01-11",
          hora: "15:20:00",
          localizacion: "CALL. ALBADALEJO, 42",
          numero: "42",
          distrito: "San Blas-Canillejas",
          estado_meteorologico: "Despejado",
          tipo_accidente: "Ca√≠da",
          tipo_vehiculo: "bicycle",
          tipo_persona: "Conductor",
          rango_edad: "De 21 a 24 a√±os",
          sexo: "Hombre",
          lesividad: "Asistencia sanitaria s√≥lo en el lugar del accidente",
          coordenada_x_utm: 447764,
          coordenada_y_utm: 4476314,
          positiva_alcohol: false,
          positiva_droga: false,
        },
        {
          expediente: "2024S000988",
          fecha: "2024-01-12",
          hora: "16:40:00",
          localizacion: "CALL. ANTONIO LOPEZ, 256A",
          numero: "256A",
          distrito: "Usera",
          estado_meteorologico: "Despejado",
          tipo_accidente: "Colisi√≥n lateral",
          tipo_vehiculo: "electric bicycle",
          tipo_persona: "Conductor",
          rango_edad: "Desconocido",
          sexo: "Hombre",
          lesividad: "Sin asistencia sanitaria",
          coordenada_x_utm: 440958,
          coordenada_y_utm: 4470107,
          positiva_alcohol: false,
          positiva_droga: false,
        },
        {
          expediente: "2024S001002",
          fecha: "2024-01-12",
          hora: "17:12:00",
          localizacion: "CALL. OLIVAR, 52",
          numero: "52",
          distrito: "Centro",
          estado_meteorologico: "Despejado",
          tipo_accidente: "Atropello a persona",
          tipo_vehiculo: "bicycle",
          tipo_persona: "Conductor",
          rango_edad: "De 35 a 39 a√±os",
          sexo: "Mujer",
          lesividad: "Sin asistencia sanitaria",
          coordenada_x_utm: 440486,
          coordenada_y_utm: 4473427,
          positiva_alcohol: false,
          positiva_droga: false,
        },
        {
          expediente: "2024S001002",
          fecha: "2024-01-12",
          hora: "17:12:00",
          localizacion: "CALL. OLIVAR, 52",
          numero: "52",
          distrito: "Centro",
          estado_meteorologico: "Despejado",
          tipo_accidente: "Atropello a persona",
          tipo_vehiculo: "bicycle",
          tipo_persona: "Peat√≥n",
          rango_edad: "De 65 a 69 a√±os",
          sexo: "Mujer",
          lesividad: "",
          coordenada_x_utm: 440486,
          coordenada_y_utm: 4473427,
          positiva_alcohol: false,
          positiva_droga: false,
        },
        {
          expediente: "2024S001006",
          fecha: "2024-01-12",
          hora: "14:35:00",
          localizacion: "CALL. LUCHANA, 16",
          numero: "16",
          distrito: "Chamber√≠",
          estado_meteorologico: "Despejado",
          tipo_accidente: "Alcance",
          tipo_vehiculo: "electric bicycle",
          tipo_persona: "Conductor",
          rango_edad: "De 15 a 17 a√±os",
          sexo: "Hombre",
          lesividad: "",
          coordenada_x_utm: 440573,
          coordenada_y_utm: 4475744,
          positiva_alcohol: false,
          positiva_droga: false,
        },
        {
          expediente: "2024S001024",
          fecha: "2024-01-12",
          hora: "22:00:00",
          localizacion: "CALL. MENDEZ ALVARO, 21",
          numero: "21",
          distrito: "Arganzuela",
          estado_meteorologico: "Despejado",
          tipo_accidente: "Alcance",
          tipo_vehiculo: "bicycle",
          tipo_persona: "Conductor",
          rango_edad: "De 21 a 24 a√±os",
          sexo: "Hombre",
          lesividad: "Ingreso inferior o igual a 24 horas",
          coordenada_x_utm: 441837,
          coordenada_y_utm: 4472409,
          positiva_alcohol: false,
          positiva_droga: false,
        },
        {
          expediente: "2024S001264",
          fecha: "2024-01-13",
          hora: "08:25:00",
          localizacion: "CALL. TOLEDO, 172",
          numero: "172",
          distrito: "Arganzuela",
          estado_meteorologico: "Despejado",
          tipo_accidente: "Ca√≠da",
          tipo_vehiculo: "electric bicycle",
          tipo_persona: "Conductor",
          rango_edad: "De 30 a 34 a√±os",
          sexo: "Hombre",
          lesividad: "Asistencia sanitaria ambulatoria con posterioridad",
          coordenada_x_utm: 439420,
          coordenada_y_utm: 4472618,
          positiva_alcohol: true,
          positiva_droga: false,
        },
        {
          expediente: "2024S001308",
          fecha: "2024-01-13",
          hora: "17:45:00",
          localizacion: "SENDA FLUVIAL DEL MANZANARES S/N",
          numero: "43",
          distrito: "Moncloa-Aravaca",
          estado_meteorologico: "Despejado",
          tipo_accidente: "Ca√≠da",
          tipo_vehiculo: "bicycle",
          tipo_persona: "Conductor",
          rango_edad: "De 45 a 49 a√±os",
          sexo: "Hombre",
          lesividad: "Ingreso inferior o igual a 24 horas",
          coordenada_x_utm: 436147,
          coordenada_y_utm: 4480165,
          positiva_alcohol: false,
          positiva_droga: false,
        },
      ];

      const accidentsRaw = accidentDataset.map((row) => ({
        exp: row.expediente,
        date: `${row.fecha}T${row.hora}`,
        loc: formatLocation(row.localizacion, row.numero),
        tipo: row.tipo_accidente,
        lesion: row.lesividad || "Sin dato",
        x: Number(row.coordenada_x_utm),
        y: Number(row.coordenada_y_utm),
        meteo: row.estado_meteorologico,
        distrito: row.distrito,
        vehiculo: normalizeVehicle(row.tipo_vehiculo),
        persona: row.tipo_persona,
        edad: row.rango_edad || "Desconocido",
        sexo: row.sexo || "Desconocido",
        positivaAlcohol: Boolean(row.positiva_alcohol),
        positivaDroga: Boolean(row.positiva_droga),
      }));

      // Process accidents: convert coords & assign color/severity
      const accidents = accidentsRaw.map((a) => {
        const [lon, lat] = proj4("EPSG:25830", "EPSG:4326", [a.x, a.y]);
        let color = "#22c55e"; // green (safe/minor)
        let weight = 1;
        let severity = "Sin asistencia";

        if (a.lesion.includes("Ingreso")) {
          color = "#ef4444";
          weight = 3;
          severity = "Ingreso 24h";
        } else if (a.lesion.includes("Asistencia")) {
          color = "#eab308";
          weight = 1.5;
          severity = "Asistencia";
        }

        return { ...a, lat, lon, color, heatWeight: weight, severity };
      });

      // --- 2. Map Initialization ---

      const map = L.map("map", { zoomControl: false }).setView(
        [40.4168, -3.7038],
        13
      );
      L.control.zoom({ position: "topright" }).addTo(map);

      // Tile Layers (CartoDB for better look)
      const lightTiles = L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
        {
          attribution: "¬© OpenStreetMap, ¬© CartoDB",
        }
      );
      const darkTiles = L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
        {
          attribution: "¬© OpenStreetMap, ¬© CartoDB",
        }
      );

      lightTiles.addTo(map); // Default

      // Layer Groups
      const layers = {
        stations: L.layerGroup().addTo(map),
        accidents: L.layerGroup().addTo(map),
        heat: L.layerGroup(), // Not added by default
        routes: L.layerGroup().addTo(map),
      };

      const filterState = {
        weather: "all",
        age: "all",
      };

      // --- 3. Logic Functions ---

      // Safety Score: 0 to 1 (1 is safest)
      function getSafetyScore(s) {
        const utilization = s.trips / 300; // Normalize trips
        const danger = Math.min(s.collisions, 5) / 5;
        let score = 0.4 * (1 - danger) + 0.6 * (s.bikes / s.cap);
        return Math.max(0.1, Math.min(1, score));
      }

      function getScoreColor(score) {
        if (score >= 0.7) return "#22c55e";
        if (score >= 0.4) return "#eab308";
        return "#ef4444";
      }

      function updateStats() {
        document.getElementById("stat-stations").innerText = stations.length;
        document.getElementById("stat-accidents").innerText = accidents.length;
      }

      // Render Stations
      function renderStations() {
        layers.stations.clearLayers();
        const listEl = document.getElementById("station-list");
        listEl.innerHTML = "";

        stations.forEach((s) => {
          const score = getSafetyScore(s);
          const color = getScoreColor(score);

          // Map Marker (Circle size based on capacity)
          const radius = 4 + s.cap / 4;
          const marker = L.circleMarker([s.lat, s.lon], {
            radius: radius,
            fillColor: "#3b82f6",
            color: "#1d4ed8",
            weight: 2,
            opacity: 1,
            fillOpacity: 0.9,
          }).addTo(layers.stations);

          const popupContent = `
          <div style="font-family:Inter; font-size:13px;">
            <strong style="font-size:14px">${s.name}</strong><br>
            <div style="margin-top:4px; display:flex; gap:8px; color:#666;">
              <span>üö≤ ${s.bikes}/${s.cap}</span>
              <span>‚ö†Ô∏è ${s.collisions} incidents</span>
            </div>
            <div style="margin-top:6px; font-weight:600; color:${color}">
              Safety Score: ${(score * 100).toFixed(0)}%
            </div>
          </div>
        `;
          marker.bindPopup(popupContent);

          // Sidebar Item
          const item = document.createElement("div");
          item.className = "stat-card";
          item.innerHTML = `
          <div class="stat-header">
            <span>${s.name}</span>
            <span class="score-badge" style="background:${color}">${(
            score * 100
          ).toFixed(0)}</span>
          </div>
          <div class="stat-row">
            <span>Avail: ${s.bikes}/${s.cap}</span>
            <span>Trips: ${s.trips}</span>
          </div>
        `;
          item.addEventListener("click", () => {
            map.flyTo([s.lat, s.lon], 15);
            marker.openPopup();
          });
          listEl.appendChild(item);
        });
      }

      // Render Accidents based on filter with detailed popup
      function renderAccidents() {
        layers.accidents.clearLayers();

        const filtered = accidents.filter((a) => {
          const weatherMatches =
            filterState.weather === "all"
              ? true
              : a.meteo
                  .toLowerCase()
                  .includes(filterState.weather.toLowerCase());
          const ageMatches =
            filterState.age === "all" ? true : a.edad === filterState.age;
          return weatherMatches && ageMatches;
        });

        filtered.forEach((a) => {
          const marker = L.circleMarker([a.lat, a.lon], {
            radius: 6,
            fillColor: a.color,
            color: "#fff",
            weight: 1,
            fillOpacity: 0.7,
          }).addTo(layers.accidents);

          // Format date
          const dateObj = new Date(a.date);
          const formattedDate = dateObj
            .toLocaleString("es-ES", {
              year: "numeric",
              month: "2-digit",
              day: "2-digit",
              hour: "2-digit",
              minute: "2-digit",
            })
            .replace(",", "");

          // Create detailed popup content matching the image
          const shouldShowDetails = a.severity !== "Sin asistencia";
          if (!shouldShowDetails) {
            return;
          }

          const popupContent = `
          <div class="accident-popup">
            <h3>Accidente ${a.exp}</h3>
            <div class="accident-detail">
              <strong>Fecha:</strong>
              <span>${formattedDate}</span>
            </div>
            <div class="accident-detail">
              <strong>Ubicaci√≥n:</strong>
              <span>${a.loc}</span>
            </div>
            <div class="accident-detail">
              <strong>Tipo:</strong>
              <span>${a.tipo}</span>
            </div>
            <div class="accident-detail">
              <strong>Distrito:</strong>
              <span>${a.distrito}</span>
            </div>
            <div class="accident-detail">
              <strong>Veh√≠culo:</strong>
              <span>${a.vehiculo}</span>
            </div>
            <div class="accident-detail">
              <strong>Persona:</strong>
              <span>${a.persona} (${a.edad})</span>
            </div>
            <div class="accident-detail">
              <strong>Meteo:</strong>
              <span>${a.meteo}</span>
            </div>
            <div class="accident-detail">
              <strong>Lesividad:</strong>
              <span>${a.lesion}</span>
            </div>
          </div>
        `;

          marker.bindPopup(popupContent, {
            maxWidth: 350,
            className: "custom-accident-popup",
          });

          marker.on("mouseover", () => {
            marker.openPopup();
          });

          marker.on("mouseout", () => {
            marker.closePopup();
          });
        });
      }

      // Heatmap Logic
      function toggleHeatmap(type) {
        layers.heat.clearLayers();
        if (map.hasLayer(layers.heat)) map.removeLayer(layers.heat);

        let points = [];
        let config = { radius: 25, blur: 15, maxZoom: 16 };

        if (type === "trips") {
          points = stations.map((s) => [s.lat, s.lon, s.trips / 50]); // scale intensity
          config.radius = 40;
          document.getElementById("legend").innerText =
            "Heatmap: High density of bicycle trips";
        } else if (type === "collisions") {
          // Use accident data for collision heat, not just station data
          points = accidents.map((a) => [a.lat, a.lon, a.heatWeight]);
          config.radius = 30;
          document.getElementById("legend").innerText =
            "Heatmap: Accident concentration zones";
        }

        L.heatLayer(points, config).addTo(layers.heat);
        map.addLayer(layers.heat);
      }

      // Routing Logic
      function drawRoute(startId, endId, isScenic = false) {
        layers.routes.clearLayers();
        layers.heat.clearLayers(); // Clear noise

        const s = stations.find((st) => st.id === startId);
        const e = stations.find((st) => st.id === endId);
        if (!s || !e) return;

        let latlngs = [];
        let color = isScenic ? "#22c55e" : "#3b82f6"; // Green for scenic, Blue for direct
        let dashArray = isScenic ? "10, 10" : null;

        if (isScenic) {
          // Mock waypoint (Malasa√±a)
          const waypoint = stations.find((st) => st.id === "5201");
          latlngs = [
            [s.lat, s.lon],
            [waypoint.lat, waypoint.lon],
            [e.lat, e.lon],
          ];
          document.getElementById(
            "legend"
          ).innerHTML = `<b>Scenic Route:</b> ${s.name} ‚Üí ${waypoint.name} ‚Üí ${e.name}<br>Distance: ~2.8 km`;
        } else {
          latlngs = [
            [s.lat, s.lon],
            [e.lat, e.lon],
          ];
          // Calculate straight line dist roughly
          const dist = map.distance([s.lat, s.lon], [e.lat, e.lon]) / 1000;
          document.getElementById("legend").innerHTML = `<b>Direct Route:</b> ${
            s.name
          } ‚Üí ${e.name}<br>Distance: ~${dist.toFixed(2)} km (Linear)`;
        }

        const poly = L.polyline(latlngs, {
          color,
          weight: 5,
          opacity: 0.8,
          dashArray,
        }).addTo(layers.routes);
        map.fitBounds(poly.getBounds(), { padding: [50, 50] });

        // Add Start/End markers on top of route
        L.marker([s.lat, s.lon])
          .addTo(layers.routes)
          .bindPopup("Start: " + s.name);
        L.marker([e.lat, e.lon])
          .addTo(layers.routes)
          .bindPopup("End: " + e.name);
      }

      function highlightSafeSpots() {
        layers.routes.clearLayers();
        const safeStations = stations
          .map((s) => ({ ...s, score: getSafetyScore(s) }))
          .sort((a, b) => b.score - a.score)
          .slice(0, 3); // Top 3

        safeStations.forEach((s) => {
          L.circleMarker([s.lat, s.lon], {
            radius: 20,
            color: "#22c55e",
            fill: false,
            weight: 3,
          }).addTo(layers.routes); // Add ring effect
        });

        document.getElementById("legend").innerText =
          "Highlighted: Top 3 safest stations based on availability and incident history.";
        map.setView([40.42, -3.7], 13);
      }

      // --- 4. Event Listeners ---

      // Theme Toggle
      document
        .getElementById("themeToggle")
        .addEventListener("click", function () {
          const isDark = document.body.classList.toggle("dark");
          this.textContent = isDark ? "‚òÄÔ∏è Light Mode" : "üåô Dark Mode";

          if (isDark) {
            map.removeLayer(lightTiles);
            darkTiles.addTo(map);
          } else {
            map.removeLayer(darkTiles);
            lightTiles.addTo(map);
          }
        });

      // Heatmap Buttons
      document
        .getElementById("btn-heat-trips")
        .addEventListener("click", () => toggleHeatmap("trips"));
      document
        .getElementById("btn-heat-coll")
        .addEventListener("click", () => toggleHeatmap("collisions"));
      document
        .getElementById("btn-safe-spots")
        .addEventListener("click", highlightSafeSpots);

      document.getElementById("btn-reset-map").addEventListener("click", () => {
        layers.heat.clearLayers();
        map.removeLayer(layers.heat);
        layers.routes.clearLayers();
        map.setView([40.4168, -3.7038], 13);
        document.getElementById("legend").innerText = "Map reset.";
      });

      // Routes
      document
        .getElementById("route-sol-plaza")
        .addEventListener("click", () => drawRoute("1001", "1012", false));
      document
        .getElementById("route-sol-plaza-scenic")
        .addEventListener("click", () => drawRoute("1001", "1012", true));
      document
        .getElementById("route-sol-atocha")
        .addEventListener("click", () => drawRoute("1001", "2030", false));

      // Weather Filter
      document
        .getElementById("weatherFilter")
        .addEventListener("change", (e) => {
          filterState.weather = e.target.value;
          renderAccidents();
        });

      document.getElementById("ageFilter").addEventListener("change", (e) => {
        filterState.age = e.target.value;
        renderAccidents();
      });

      // --- 5. Init ---
      renderStations();
      renderAccidents();
      updateStats();
    </script>
  </body>
</html>
